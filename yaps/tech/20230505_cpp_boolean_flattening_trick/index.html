<html lang=en><head><meta charset=UTF-8><link rel=stylesheet href=/css/index.css><link rel="shortcut icon" type=image/png href=/img/favicon.png><title>moom</title>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div id=container><div id=title>tech</div><article id=blog><div class=blog-title>C++ Flatten integer to 0/1</div><div class=blog-date><time datetime=2023-05-05T13:25:00+08:00>May 5, 2023</time></div><div class=blog-body><p>This is a quick trick to 'flatten' an integer into a 1 or 0.
This is probably a trick that only works in C/C++ because of how the not (!) operator works with integers.
While it's usefulness is dubious in C++, it might be useful in C.</p><p>The trick is simply this:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#c1abea>x</span> <span style=color:#c7bf54>=</span> <span style=color:#c7bf54>!!</span><span style=color:#c1abea>x</span>;
</span></span></code></pre></div><p>When <code>x</code> is 0, x will remain 0.
When <code>x</code> is any other number, x will be 'flattened' to 1.</p><p>You might ask, why not do something like this?</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#c1abea>x</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>x</span> <span style=color:#c7bf54>?</span> <span style=color:#d19a66>1</span> <span style=color:#c7bf54>:</span> <span style=color:#d19a66>0</span>;
</span></span></code></pre></div><p>Does the statement above use more instruction because it is a conditional?</p><p>Don't worry, my friend.
I got you covered.
I'm a good engineer who at least have the decency to check against <a href>Godbolt</a>:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ef8383>int</span> <span style=color:#c1abea>g_fullscreen</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef8383>int</span> <span style=color:#00b1f7>foo3</span>() {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>if</span> (<span style=color:#c1abea>g_fullscreen</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#d19a66>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#c678dd>else</span> 
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#d19a66>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef8383>int</span> <span style=color:#00b1f7>foo2</span>() {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>return</span> <span style=color:#c7bf54>!!</span><span style=color:#c1abea>g_fullscreen</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef8383>int</span> <span style=color:#00b1f7>foo1</span>() {
</span></span><span style=display:flex><span>  <span style=color:#c678dd>return</span> <span style=color:#c1abea>g_fullscreen</span> <span style=color:#c7bf54>?</span> <span style=color:#d19a66>1</span> <span style=color:#c7bf54>:</span> <span style=color:#d19a66>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef8383>int</span> <span style=color:#00b1f7>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#c1abea>foo1</span>();
</span></span><span style=display:flex><span>  <span style=color:#c1abea>foo2</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And turns out, in all relevant compilers today (GCC, Clang and MSVC), they all give the same instructions.</p><p>Here is Clang:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#00b1f7>foo3</span>():                               <span style=color:#8a93a5;font-style:italic># @foo3()
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>dword</span> <span style=color:#b756ff;font-weight:700>ptr</span> [<span style=color:#b756ff;font-weight:700>rip</span> + <span style=color:#b756ff;font-weight:700>g_fullscreen</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>foo2</span>():                               <span style=color:#8a93a5;font-style:italic># @foo2()
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>dword</span> <span style=color:#b756ff;font-weight:700>ptr</span> [<span style=color:#b756ff;font-weight:700>rip</span> + <span style=color:#b756ff;font-weight:700>g_fullscreen</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>foo1</span>():                               <span style=color:#8a93a5;font-style:italic># @foo1()
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>dword</span> <span style=color:#b756ff;font-weight:700>ptr</span> [<span style=color:#b756ff;font-weight:700>rip</span> + <span style=color:#b756ff;font-weight:700>g_fullscreen</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>main:</span>                                   <span style=color:#8a93a5;font-style:italic># @main
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>g_fullscreen:</span>
</span></span><span style=display:flex><span>        <span style=color:#b3d23c>.long</span>   <span style=color:#d19a66>0</span>                               <span style=color:#8a93a5;font-style:italic># 0x0
</span></span></span></code></pre></div><p>MSVC</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span> <span style=color:#b756ff;font-weight:700>DD</span> <span style=color:#d19a66>01</span><span style=color:#b756ff;font-weight:700>H</span> <span style=color:#b756ff;font-weight:700>DUP</span> (?)                 <span style=color:#8a93a5;font-style:italic>; g_fullscreen
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo3</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>PROC</span>                                 <span style=color:#8a93a5;font-style:italic>; foo3, COMDAT
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>int</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>, <span style=color:#b756ff;font-weight:700>eax</span> <span style=color:#8a93a5;font-style:italic>; g_fullscreen
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>     <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo3</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>ENDP</span>                                 <span style=color:#8a93a5;font-style:italic>; foo3
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo2</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>PROC</span>                                 <span style=color:#8a93a5;font-style:italic>; foo2, COMDAT
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>int</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>, <span style=color:#b756ff;font-weight:700>eax</span> <span style=color:#8a93a5;font-style:italic>; g_fullscreen
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>     <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo2</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>ENDP</span>                                 <span style=color:#8a93a5;font-style:italic>; foo2
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo1</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>PROC</span>                                 <span style=color:#8a93a5;font-style:italic>; foo1, COMDAT
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>int</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>, <span style=color:#b756ff;font-weight:700>eax</span> <span style=color:#8a93a5;font-style:italic>; g_fullscreen
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>     <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>int</span> <span style=color:#b756ff;font-weight:700>foo1</span>(<span style=color:#b756ff;font-weight:700>void</span>) <span style=color:#b756ff;font-weight:700>ENDP</span>                                 <span style=color:#8a93a5;font-style:italic>; foo1
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>_main</span>   <span style=color:#b756ff;font-weight:700>PROC</span>                                      <span style=color:#8a93a5;font-style:italic>; COMDAT
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#00b1f7>xor</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>     <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>_main</span>   <span style=color:#b756ff;font-weight:700>ENDP</span>
</span></span></code></pre></div><p>GCC:</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#00b1f7>foo3</span>():
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>[<span style=color:#b756ff;font-weight:700>rip</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>movzx</span>   <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>foo2</span>():
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>[<span style=color:#b756ff;font-weight:700>rip</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>movzx</span>   <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#00b1f7>foo1</span>():
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>cmp</span>     <span style=color:#b756ff;font-weight:700>DWORD</span> <span style=color:#b756ff;font-weight:700>PTR</span> <span style=color:#b756ff;font-weight:700>g_fullscreen</span>[<span style=color:#b756ff;font-weight:700>rip</span>], <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>setne</span>   <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>movzx</span>   <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#b756ff;font-weight:700>al</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>main:</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>mov</span>     <span style=color:#b756ff;font-weight:700>eax</span>, <span style=color:#d19a66>0</span>
</span></span><span style=display:flex><span>        <span style=color:#00b1f7>ret</span>
</span></span><span style=display:flex><span><span style=color:#f5a40d>g_fullscreen:</span>
</span></span><span style=display:flex><span>        <span style=color:#b3d23c>.zero</span>   <span style=color:#d19a66>4</span>
</span></span></code></pre></div><p>It turns out that for this specific case, using the trick == conditional statement == tenary operator.
That is, there is no performance difference!</p><p>In conclusion, just put this trick into your bag.
Don't go around crusading other to use it :)</p></div></div></div></body></html>